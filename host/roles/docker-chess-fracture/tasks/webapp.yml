---

- name: install rust
  shell: curl https://sh.rustup.rs -sSf | sh -s -- -y --default-toolchain nightly
  args:
    creates: "/home/{{ ansible_user }}/.cargo/bin/cargo"
    warn: false
  become_user: "{{ ansible_user }}"

- name: build webapp
  command: /home/ansible/.cargo/bin/cargo build
  args:
    chdir: "/home/{{ ansible_user }}/docker-chess-fracture/webapp"
    creates: "/home/{{ ansible_user }}/docker-chess-fracture/webapp/target/"
  become_user: "{{ ansible_user }}"
  notify: restart webapp

- name: copy webapp startup script
  template:
    src: usr/lib/systemd/system/webapp.service.j2
    dest: /usr/lib/systemd/system/webapp.service
  notify: systemctl daemon-reload

- name: start webapp
  service:
    name: webapp
    state: started
    enabled: yes

- name: create /pgn
  file:
    path: /pgn
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
